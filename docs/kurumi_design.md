# Kurumi 虚拟机设计

## 指令集

| 指令 | 弹栈数 | 压栈数 | 描述 |
| ---- | ------ | ------ | ---- |
|      |        |        |      |

## 内存设计

### 栈

```
| __ 栈顶 __      <- sp
| ...
| 运算区
| ...
| 局部变量
| 返回地址        <- sps[-1]
| --------------- ^ 当前函数调用栈
| 参数个数
| ...
| 函数参数
| ...
| 运算区
| ...
| 局部变量
| 返回地址        <- sps[-2]
| --------------- ^ 上个函数调用栈
| -- snip --
| ---------------
| ...
| 局部变量
| 返回地址 = 0    <- sps[0]
| --------------- ^ main 函数调用栈
| main 参数
| -- 栈底 -- = 0xFFFF_FFFF_FFFF_FFFF
```

其中，sps 是储存调用栈地址的堆栈，按照调用顺序储存调用栈中每个栈帧的顶部地址。

为了实现简便，堆栈中所有数据都是 32 或 64 位对齐的（根据编译时 `usize` 大小）。

### 内存分配

Kurumi VM 有 `usize_max` 字节的虚拟内存。栈在虚拟内存的最顶端，大小 1 MiB。

```
|---------------- = 0xFFFF_FFFF_FFFF_FFFF
| 栈区
| |
| v
|---------------- = 0xFFFF_FFFE_FFFF_FFFF ( ^ 1MiB )
|
| 堆
|
|
|----------------
| 全局变量
|---------------- = 0x0000_0000_0000_0000
```
